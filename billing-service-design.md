## Functional Requirements

- Patients enroll in a paid plan **separate** from patient creation:
  - BASIC: **$100/mo**
  - STANDARD: **$200/mo**
  - PREMIUM: **$400/mo**
  - Annual billing = **10% off** `12 × monthly` price.
- Optional **single discount** per account:
  - `WELCOME10`: 10% off first month, any plan.
  - `NONPROFIT50`: $50/mo off BASIC or STANDARD only.
  - PREMIUM is **not discountable**.
- Mid-cycle plan changes allowed:
  - Prorate by crediting unused portion of old plan and debiting remaining portion of new plan.
- Invoices:
  - Generated by a scheduler in `billing-service`.
  - Each invoice itemizes base charge, proration credit/debit, discount, and total.
  - Each invoice emits an `invoice-created` event.
- Clients can fetch billing account and invoices per patient.

---

## New / Changed Entities (billing-service)

### `plan`

- **PK**: `code`
- Fields:
  - `name`
  - `monthly_price_cents`
  - `annual_price_cents`
  - `proration_policy`
  - `discountable`
  - `active`

### `discount`

- **PK**: `code`
- Fields:
  - `type` = `PERCENT` | `AMOUNT`
  - `value`
  - `applies_to_plan_code` (nullable)
  - `active`

### `billing_account`

- **PK**: `id` (UUID)
- Fields:
  - `patient_id` (UUID)
  - `plan_code`
  - `discount_code` (nullable)
  - `status` = `ACTIVE` | `CANCELED`
  - `cycle_anchor`
  - `cadence` = `MONTHLY` | `ANNUAL`
  - `currency`
  - `activated_at`
  - `canceled_at`
  - `last_invoiced_end` (nullable)

### `invoice`

- **PK**: `id` (UUID)
- Fields:
  - `billing_account_id`
  - `period_start`
  - `period_end`
  - `subtotal_cents`
  - `proration_cents`
  - `discount_cents`
  - `total_cents`
  - `status` = `DUE` | `PAID`
  - `created_at`
  - `due_at`

### `invoice_line`

- **PK**: `id` (UUID)
- Fields:
  - `invoice_id`
  - `description`
  - `amount_cents`
  - `quantity`

---

## Entity Field Usage & Relationships

### `plan` (PK `code`)

- `monthly_price_cents` / `annual_price_cents`: price lookup for billing cycle.
- `proration_policy`: how to prorate mid-cycle change (e.g., `DAILY`).
- `discountable`: if false, discounts are rejected.
- **Relationship**: referenced by `billing_account.plan_code`.

### `discount` (PK `code`)

- `type` (`PERCENT` | `AMOUNT`) and `value`: define reduction.
- `applies_to_plan_code` (nullable):
  - `null` = applies to all plans.
  - non-null = limited to specific plan.
- `active`: used to reject expired discounts.
- **Relationship**: referenced by `billing_account.discount_code` and validated alongside `plan.discountable`.

### `billing_account` (PK `id`)

- `patient_id`: logical FK to patient (stored as UUID).
- `plan_code`, `discount_code`: current selections, validated via `PlanCatalogService`.
- `status`:
  - `ACTIVE` at creation.
  - `CANCELED` when enrollment is explicitly ended.
- `cycle_anchor`: date billing cycle starts; used for periods/proration windows.
- `cadence`: `MONTHLY` or `ANNUAL`.
- `last_invoiced_end`: end date of last generated period; scheduler uses to derive next period.
- `activated_at`, `canceled_at`: lifecycle timestamps.
- **Relationship**: has many `invoice` rows via `invoice.billing_account_id`.

### `invoice` (PK `id`)

- `billing_account_id`: FK to `billing_account`.
- `period_start`, `period_end`: covered billing window.
- `subtotal_cents`: base plan charge for period.
- `proration_cents`: net proration (negative = credit).
- `discount_cents`: discount applied (non-negative).
- `total_cents` = `subtotal + proration – discount` (floor ≥ 0).
- `status`:
  - `DUE` at creation.
  - `PAID` when settled (reserved).
- `created_at`, `due_at`: lifecycle and payment due timestamps.
- **Relationship**: has many `invoice_line` rows.

### `invoice_line` (PK `id`)

- `invoice_id`: FK to `invoice`.
- `description`: e.g., `"Base plan STANDARD"`, `"Proration credit from BASIC"`, `"Discount WELCOME10"`.
- `amount_cents`: positive (charge) or negative (credit).
- `quantity`: default 1.
- **Relationship**: belongs to one `invoice`; contributes to totals.

---

## API Design

### Patient-service REST (facade → billing gRPC)

- `POST /patients/{id}/plan-enrollment`  
  → billing gRPC `CreateBillingAccount` if none, else `UpdateBillingAccountPlan`.
- `GET /patients/{id}/billing-account`  
  → billing gRPC `GetBillingAccount`.
- `GET /patients/{id}/invoices`  
  → billing gRPC `ListInvoices`.
- `GET /patients/{id}/invoices/{invoiceId}`  
  → billing gRPC `GetInvoice`.

### Billing-service gRPC

- `CreateBillingAccount(BillingAccountCreateRequest { patientId, planCode, discountCode? }) -> BillingAccountResponse`
- `UpdateBillingAccountPlan(BillingAccountPlanChangeRequest { patientId, newPlanCode, discountCode?, effectiveDate? }) -> BillingAccountResponse`
- `GetBillingAccount(GetBillingAccountRequest { patientId | billingAccountId }) -> BillingAccountResponse`
- `ListInvoices(ListInvoicesRequest { patientId | billingAccountId, page, size }) -> ListInvoicesResponse`
- `GetInvoice(GetInvoiceRequest { invoiceId }) -> InvoiceResponse`
- `ListPlans(Empty) -> ListPlansResponse` (optional for discovery)

### Billing-service Kafka

- Emit `BillingInvoiceCreated` to topic `billing-invoice` with:
  - `patientId`
  - `invoiceId`
  - `planCode`
  - `periodStart`
  - `periodEnd`
  - `totalCents`

---

## High-Level Design / Flow

### Enrollment / Change

- Client calls `patient-service /plan-enrollment` with `planCode` / `discountCode`.
- `patient-service`:
  - Checks ownership (`X-User-Id` vs path `id`).
  - Invokes billing gRPC `CreateBillingAccount` or `UpdateBillingAccountPlan`.
- `billing-service`:
  - Validates plan/discount.
  - Sets `status=ACTIVE`, `cadence`, `cycle_anchor=now`, `activated_at=now`.
  - Persists account.

### Invoice Generation (scheduled in billing-service)

- Daily `@Scheduled` job:
  - Queries `ACTIVE` accounts whose next period is due:
    - `period_start` = `last_invoiced_end` or `cycle_anchor`.
    - `period_end` = +1 month or +12 months (based on `cadence`).
  - For each due account:
    - Call `InvoiceGenerator` to create invoice + lines in **one transaction**.
    - Set `status=DUE`.
    - Update `last_invoiced_end` to `period_end`.
    - Emit `BillingInvoiceCreated`.
- Idempotency:
  - Uniqueness on `(billing_account_id, period_start, period_end)` or explicit request key.
  - Skip creation if an invoice already exists for that period.

### Retrieval

- `patient-service` GET endpoints:
  - Call billing gRPC `GetBillingAccount` / `ListInvoices` / `GetInvoice`.
  - Return mapped REST responses.

### Discovery

- Clients can fetch plans via billing gRPC `ListPlans`  
  (or via a `patient-service` pass-through endpoint, if exposed).

---

## Technical Design

### PlanCatalogService

- **Responsibility**: load plan/discount, validate compatibility, return value objects.
- **Flow**:
  - Fetch plan by code (must be `active`).
  - If `discountCode` present:
    - Fetch discount (active).
    - Ensure `plan.discountable = true`.
    - Ensure `discount.applies_to_plan_code` is `null` or matches plan.
  - Return `PlanInfo` + optional `DiscountInfo`.
- **Errors**:
  - `PlanNotFound` / `PlanInactive`
  - `DiscountNotFound` / `DiscountInactive`
  - `DiscountNotAllowed`
  - `PlanNotDiscountable`  
  → mapped to `INVALID_ARGUMENT` / `NOT_FOUND`.
- **Persistence**:
  - Read-only via `PlanRepository` / `DiscountRepository`.
  - Optional caching.

### BillingAccountService

- **Responsibility**: create/update `billing_account`.
- **Flow – create**:
  - Validate via `PlanCatalogService`.
  - Set:
    - `status=ACTIVE`
    - `plan_code`, `discount_code`
    - `cadence` (from request)
    - `cycle_anchor=now`
    - `activated_at=now`
    - `last_invoiced_end=null`
  - Save.
- **Flow – update (plan change)**:
  - Load account (`ACTIVE` only).
  - Validate new plan/discount.
  - Update `plan_code` / `discount_code`.
  - Keep `cycle_anchor` unless realigning.
  - Do not change `activated_at`.
  - Keep `last_invoiced_end`.
  - Save.
- **Errors**:
  - `AccountNotFound`
  - `AccountCanceled`
  - Invalid plan/discount.
  - Persistence failures → propagate `DataAccessException`.

### ProrationEngine

- **Responsibility**: compute proration when plan changes mid-cycle.
- **Flow**:
  - Inputs: `oldPlan`, `newPlan`, `changeDate`, `period_start`, `period_end`.
  - Compute:
    - Unused days for old plan → credit.
    - Remaining days for new plan → debit.
    - Policy: `DAILY`.
  - Return **line items with signed amounts**.
- **Errors**:
  - Input validation only.
  - Returns zero if change happens on period boundary.

### DiscountApplier

- **Responsibility**: apply percent/fixed discounts to `subtotal + proration`.
- **Flow**:
  - If discount present and `plan.discountable`:
    - Compute discount amount.
    - Cap so `total >= 0`.
    - Return discount value + discount line.
- **Errors**:
  - Validation already handled in `PlanCatalogService`.
  - Guards against negative totals.

### InvoiceGenerator

- **Responsibility**: build and persist invoice + lines; update account invoicing cursor; emit event.
- **Flow (transactional)**:
  1. Load `billing_account` (`ACTIVE`) with plan/discount via `PlanCatalogService`.
  2. Determine:
     - `period_start` = `last_invoiced_end` or `cycle_anchor`.
     - `period_end` = by `cadence`.
  3. Idempotency guard:
     - Check existing invoice for `(billing_account_id, period_start, period_end)`.
     - If exists, skip/return existing.
  4. Compute:
     - Base line (plan price for cadence).
     - Proration lines via `ProrationEngine`.
     - Discount line via `DiscountApplier`.
  5. Aggregate:
     - `subtotal_cents` (base).
     - `proration_cents` (net).
     - `discount_cents`.
     - `total_cents = subtotal + proration – discount` (>= 0).
  6. Insert invoice:
     - `status=DUE`
     - `created_at=now`
     - `due_at` = per policy.
  7. Insert `invoice_line` rows.
  8. Update `billing_account.last_invoiced_end = period_end`.
- **After commit**:
  - Use `BillingKafkaProducer` to emit `BillingInvoiceCreated`.
- **Errors**:
  - `AccountNotFound` / `AccountCanceled`
  - `IdempotencyViolation`
  - `DataAccessException`  
  → mapped to `INTERNAL` / `INVALID_ARGUMENT` via gRPC mapper.

### BillingKafkaProducer

- **Responsibility**: publish `invoice-created` event.
- **Flow**:
  - Build event payload from invoice/account.
  - Send to topic `billing-invoice`.
- **Errors**:
  - Log and optionally retry/backoff.
  - Failures do **not** roll back invoice transaction (consider outbox pattern later).

### BillingGrpcService

- **Responsibility**: map gRPC endpoints to domain services.
- **Flow**:
  - Each RPC:
    - Validates request shape.
    - Calls underlying service.
    - Maps domain exceptions to gRPC statuses (`NOT_FOUND`, `INVALID_ARGUMENT`, `FAILED_PRECONDITION`, `INTERNAL`).
- **Errors**:
  - Consistent status mapping.
  - Log with correlation/requestId.

### Scheduler (`InvoiceScheduler`)

- **Responsibility**: drive periodic invoice generation.
- **Flow**:
  - `@Scheduled` daily:
    - Query `ACTIVE` accounts where next period is due:
      - `period_start` = `last_invoiced_end` or `cycle_anchor`.
      - `period_end` by `cadence`.
      - Due if `period_end <= today`.
    - For each, call `InvoiceGenerator`.
    - Catch & log errors to avoid blocking the loop.
- **Idempotency**:
  - Relies on `InvoiceGenerator` uniqueness check on `(billing_account_id, period_start, period_end)`.
- **Errors**:
  - Log and continue.
  - Metrics for failed accounts (optional).

### Patient-service Integration

- **Controller** `POST /patients/{id}/plan-enrollment`:
  - Ownership check.
  - Call billing gRPC create/update.
- **Pass-through GETs**:
  - Call billing gRPC `GetBillingAccount` / `ListInvoices` / `GetInvoice`.
  - Surface errors as appropriate HTTP 4xx/5xx.
